pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        IMAGE_NAME     = "bookstore-app"
        CONTAINER_NAME = "bookstore-app"
        APP_PORT       = "2008"
        BUILD_TAG      = "${env.BUILD_NUMBER}"
    }


    stages {

        stage('Verify Structure') {
            steps {
                sh '''
                pwd
                ls -la
                ls -la bookStore
                '''
            }
        }

        stage('Build & Test') {
            steps {
                sh '''
                cd bookStore
                chmod +x mvnw
                ./mvnw clean package -DskipTests
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                cd bookStore
                docker build -t ${IMAGE_NAME}:${BUILD_TAG} .
                docker tag ${IMAGE_NAME}:${BUILD_TAG} ${IMAGE_NAME}:latest
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                docker network create bookstore-network 2>/dev/null || true

                # Clean old backup
                if docker ps -a --format '{{.Names}}' | grep -q '^bookstore-app_backup$'; then
                  docker rm -f bookstore-app_backup
                fi

                # Backup running container
                if docker ps -a --format '{{.Names}}' | grep -q '^bookstore-app$'; then
                  docker stop bookstore-app || true
                  docker rename bookstore-app bookstore-app_backup
                fi

                # Deploy new version
                docker run -d \
                  --name bookstore-app \
                  --network bookstore-network \
                  -p 2008:8080 \
                  -e SPRING_PROFILES_ACTIVE=docker \
                  ${IMAGE_NAME}:${BUILD_TAG}
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                echo "Waiting for application to become healthy..."

                HEALTHY=false

                for i in {1..12}; do
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://bookstore-app:8080/actuator/health || echo "000")

                  if [ "$STATUS" = "200" ]; then
                    echo "‚úÖ Application is healthy"
                    HEALTHY=true
                    break
                  fi

                  echo "Attempt $i: not ready yet (status=$STATUS)..."
                  sleep 10
                done

                if [ "$HEALTHY" = "false" ]; then
                  echo "‚ö†Ô∏è Health check failed, but continuing deployment"
                fi
                '''
            }
        }
    }

    post {

        always {
            echo "üßπ Cleaning workspace..."
            cleanWs()
        }

        success {
            emailext(
                subject: "‚úÖ SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>Build Successful</h2>
                    <p><b>Job:</b> ${env.JOB_NAME}</p>
                    <p><b>Build:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Deployed Image:</b> bookstore-app:${env.BUILD_NUMBER}</p>
                    <p><b>Status:</b> SUCCESS</p>
                """,
                to: "asifazam789@gmail.com"
            )
        }

        failure {
            emailext(
                subject: "‚ùå FAILURE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <h2>Build Failed</h2>
                    <p><b>Job:</b> ${env.JOB_NAME}</p>
                    <p><b>Build:</b> #${env.BUILD_NUMBER}</p>
                    <p><b>Status:</b> FAILED</p>
                    <p>Check Jenkins console for details.</p>
                """,
                to: "asifazam789@gmail.com"
            )
        }
    }
}
