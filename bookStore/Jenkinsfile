pipeline {
    agent any

    environment {
        IMAGE_NAME     = "bookstore-app"
        CONTAINER_NAME = "bookstore-app"
        APP_PORT       = "2008"
        PROJECT_DIR    = "bookStore"
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                    echo "=== Workspace Structure ==="
                    echo "Workspace: $WORKSPACE"
                    pwd
                    echo "Listing root:"
                    ls -la
                    echo "Listing $PROJECT_DIR directory:"
                    ls -la $PROJECT_DIR/
                    echo "Looking for pom.xml:"
                    find . -name "pom.xml" -type f
                    echo "Looking for Dockerfile:"
                    find . -name "Dockerfile" -type f
                '''
            }
        }

        stage('Build & Test') {
            steps {
                sh '''
                    echo "Building project inside Maven container..."

                    docker run --rm \
                      -u $(id -u):$(id -g) \
                      -v "$WORKSPACE/$PROJECT_DIR":/app \
                      -v /var/jenkins_home/.m2:/root/.m2 \
                      -w /app \
                      maven:3.9.6-eclipse-temurin-21 \
                      mvn clean package
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                    echo "Building application Docker image..."
                    echo "Working directory: $WORKSPACE/$PROJECT_DIR"

                    # Build Docker image from the project directory
                    cd "$WORKSPACE/$PROJECT_DIR"

                    # Check for Dockerfile
                    if [ ! -f "Dockerfile" ]; then
                        echo "ERROR: Dockerfile not found in $PWD"
                        echo "Current directory contents:"
                        ls -la
                        exit 1
                    fi

                    echo "Dockerfile found. Building image..."
                    docker build --pull -t $IMAGE_NAME .

                    # Verify image
                    echo "Verifying Docker image was created..."
                    docker images | grep $IMAGE_NAME
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    echo "Deploying application..."

                    # Create network if it doesn't exist
                    docker network create bookstore-network 2>/dev/null || true

                    # Stop and remove existing container
                    docker rm -f $CONTAINER_NAME 2>/dev/null || true

                    # Run new container
                    echo "Starting container $CONTAINER_NAME on port $APP_PORT..."
                    docker run -d \
                      --name $CONTAINER_NAME \
                      --network bookstore-network \
                      -p ${APP_PORT}:8080 \
                      -e SPRING_PROFILES_ACTIVE=docker \
                      $IMAGE_NAME

                    echo "Waiting for container to start..."
                    sleep 5

                    # Check container status
                    echo "Container status:"
                    docker ps | grep $CONTAINER_NAME || echo "Container not found in running state"

                    # Check logs
                    echo "Checking container logs (last 10 lines):"
                    docker logs $CONTAINER_NAME --tail 10 2>/dev/null || echo "Could not retrieve logs"

                    echo "Deployment complete!"
                '''
            }
        }
    }

    post {
        success {
            echo 'Pipeline completed successfully!'
            sh '''
                echo "=== Deployment Summary ==="
                echo "Application: $CONTAINER_NAME"
                echo "Port: $APP_PORT"
                echo "Docker Network: bookstore-network"
                echo "Container status:"
                docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                echo ""
                echo "To access the application:"
                echo "curl http://localhost:$APP_PORT"
                echo "or"
                echo "curl http://localhost:$APP_PORT/actuator/health"
            '''
        }
        failure {
            echo 'Pipeline failed!'
            sh '''
                echo "=== Debug Information ==="
                echo "Recent Docker containers:"
                docker ps -a --last 3
                echo ""
                echo "Docker images (last 5):"
                docker images | head -6
                echo ""
                echo "Checking for $CONTAINER_NAME logs:"
                docker logs $CONTAINER_NAME 2>/dev/null | tail -20 || echo "No logs available"
                echo ""
                echo "Disk usage in workspace:"
                du -sh $WORKSPACE/*
            '''
        }
    }
}