pipeline {
    agent any

    environment {
        IMAGE_NAME     = "bookstore-app"
        CONTAINER_NAME = "bookstore-app"
        APP_PORT       = "2008"
    }

    stages {
        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                echo "=== Workspace Structure ==="
                echo "Workspace: $WORKSPACE"
                pwd
                ls -la
                echo "Looking for pom.xml:"
                find . -name "pom.xml" -type f
                echo "Looking for Dockerfile:"
                find . -name "Dockerfile" -type f
                '''
            }
        }

        stage('Build & Test') {
            steps {
                sh '''
                echo "Building project inside Maven container..."

                # Prepare writable maven cache
                mkdir -p "$WORKSPACE/.m2"

                docker run --rm \
                  -u $(id -u):$(id -g) \
                  -v "$WORKSPACE/bookStore":/app \
                  -v "$WORKSPACE/.m2":/tmp/.m2 \
                  -e MAVEN_OPTS="-Dmaven.repo.local=/tmp/.m2" \
                  -w /app \
                  maven:3.9.6-eclipse-temurin-21 \
                  mvn clean package -DskipTests

                echo "Checking build results..."
                if [ -d "$WORKSPACE/bookStore/target" ]; then
                    echo "Build successful! JAR files:"
                    find "$WORKSPACE/bookStore/target" -name "*.jar" -type f
                else
                    echo "ERROR: Build failed - no target directory"
                    exit 1
                fi
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                echo "Building application Docker image..."
                cd "$WORKSPACE/bookStore"

                if [ ! -f "Dockerfile" ]; then
                    echo "ERROR: Dockerfile not found!"
                    ls -la
                    exit 1
                fi

                docker build --pull -t $IMAGE_NAME .
                docker images $IMAGE_NAME
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                echo "Deploying application..."

                docker network create bookstore-network 2>/dev/null || true
                docker rm -f $CONTAINER_NAME 2>/dev/null || true

                docker run -d \
                  --name $CONTAINER_NAME \
                  --network bookstore-network \
                  -p ${APP_PORT}:8080 \
                  -e SPRING_PROFILES_ACTIVE=docker \
                  $IMAGE_NAME

                sleep 10
                docker ps --filter "name=$CONTAINER_NAME"
                echo "Application available at: http://localhost:${APP_PORT}"
                '''
            }
        }
    }

    post {
        success {
            echo "Pipeline succeeded — CI/CD completed successfully."
        }
        failure {
            echo "Pipeline failed — check logs above."
        }
    }
}
