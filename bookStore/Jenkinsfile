pipeline {
    agent any

    triggers {
        githubPush()
    }

    environment {
        IMAGE_NAME     = "bookstore-app"
        CONTAINER_NAME = "bookstore-app"
        APP_PORT       = "2008"
    }

    stages {

        stage('Verify Structure') {
            steps {
                sh '''
                pwd
                ls -la
                ls -la bookStore
                '''
            }
        }

        stage('Build & Test') {
            steps {
                sh '''
                cd bookStore
                chmod +x mvnw
                ./mvnw clean package -DskipTests
                '''
            }
        }

        stage('Docker Build') {
            steps {
                sh '''
                cd bookStore
                docker build -t $IMAGE_NAME .
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                docker network create bookstore-network 2>/dev/null || true

                # Remove any old backup
                if docker ps -a --format '{{.Names}}' | grep -q '^bookstore-app_backup$'; then
                  echo "Removing old backup..."
                  docker rm -f bookstore-app_backup
                fi

                # If current app exists, stop & rename it
                if docker ps -a --format '{{.Names}}' | grep -q '^bookstore-app$'; then
                  echo "Stopping current container..."
                  docker stop bookstore-app || true
                  docker rename bookstore-app bookstore-app_backup
                fi

                echo "Starting new container..."
                docker run -d \
                  --name bookstore-app \
                  --network bookstore-network \
                  -p 2008:8080 \
                  -e SPRING_PROFILES_ACTIVE=docker \
                  bookstore-app
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                echo "Waiting for application to become healthy..."

                HEALTHY=false

                for i in {1..12}; do
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://bookstore-app:8080/actuator/health || echo "000")

                  if [ "$STATUS" = "200" ]; then
                    echo "✅ Application is healthy"
                    HEALTHY=true
                    break
                  fi

                  echo "Attempt $i: not ready yet (status=$STATUS)..."
                  sleep 10
                done

                if [ "$HEALTHY" = "false" ]; then
                  echo "⚠️ Health check failed, but continuing deployment"
                fi
                '''
            }
        }
    }

    post {
        failure {
            sh '''
            echo "⚠️ Deployment failed — rolling back"

            docker rm -f ${CONTAINER_NAME} || true

            if docker ps -a | grep ${CONTAINER_NAME}_backup; then
                docker rename ${CONTAINER_NAME}_backup ${CONTAINER_NAME}
                docker start ${CONTAINER_NAME}
                echo "♻️ Rollback completed"
            fi
            '''
        }

        success {
            echo '✅ Pipeline completed successfully!'
        }

        always {
            cleanWs()
        }
    }
}
